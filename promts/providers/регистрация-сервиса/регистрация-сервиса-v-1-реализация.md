# План реализации функционала регистрации сервиса

## 1. Создать кнопку перехода на страницу регистрации сервиса

### 1.1 Создать баннер на странице "Каталог" ✅
- **Компонент**: `ServiceRegistrationBanner`
- **Файл**: `src/components/ServiceRegistrationBanner.tsx`
- **Интеграция**: Добавить в `src/app/catalog/page.tsx`

### 1.2 Создать страницу регистрации сервиса ✅
- **Страница**: `src/app/services/registration/page.tsx`
- **Компонент**: `ServiceRegistrationPage`
- **Маршрут**: `/services/registration`

## 2. Создать форму регистрации сервиса

### 2.1 Создать основную форму ✅
- **Компонент**: `ServiceRegistrationForm`
- **Файл**: `src/app/services/registration/_components/ServiceRegistrationForm.tsx`
- **DTO**: `ServiceRegistrationDto` в `src/types/service.ts`
- **Хук**: `useServiceRegistration` в `src/app/services/registration/_hooks/useServiceRegistration.ts`

### 2.2 Реализовать поля сервиса ✅
- **Компоненты**: 
  - `ServiceNameInput` - поле названия
  - `ServiceDescriptionInput` - поле описания  
  - `ServicePriceInput` - поле цены

### 2.3 Реализовать выбор категории ✅
- **Компонент**: `CategorySelectionModal`
- **Файл**: `src/app/services/registration/_components/CategorySelectionModal.tsx`
- **Repository метод**: `findAllParentWithChildren()` в `CategoryRepository`
- **Интерфейс**: `ParentCategoryWithChildren` в `src/model/CategoryType.ts`
- **API**: `/api/categories/parent-with-children` для получения данных

### 2.4 Реализовать поля локации ✅
- **Компоненты**:
  - `ServiceAddressInput` - поле адреса
  - `ServiceAreaSelect` - выбор зоны
- **Repository**: `AreaRepository` для получения списка зон
- **Интерфейс**: `AreaEntity` в `src/entity/AreaEntity.ts`
- **API**: `/api/areas` для получения данных

### 2.5 Реализовать поля контактов ✅
- **Компоненты**:
  - `ServicePhoneInput` - поле телефона
  - `ServiceTelegramInput` - поле телеграма

### 2.6 Реализовать выбор опций категорий ✅
- **Компонент**: `ServiceOptionsSelection`
- **Файл**: `src/app/services/registration/_components/ServiceOptionsSelection.tsx`
- **Источник данных**: Утилита `serviceOptions.ts` с константами

## 3. Создать API для сохранения сервиса

### 3.1 Создать endpoint ✅
- **API Route**: `src/app/api/services/create/route.ts`
- **Модель**: `ServiceCreateModel` в `src/model/ServiceType.ts`
- **Entity**: `CreateServiceEntity` на уровне репозитория

### 3.2 Реализовать сервисный слой ✅
- **Сервис**: `ServiceRegistrationService`
- **Файл**: `src/service/ServiceRegistrationService.ts`
- **Методы**: `createService(serviceData: ServiceCreateModel): Promise<CreateServiceEntity>`

### 3.3 Реализовать репозиторный слой ✅
- **Repository**: `ServiceRepository` (расширить существующий)
- **Методы**: `createService(serviceData: ServiceCreateModel): Promise<CreateServiceEntity>`
- **Особенности**: Использовать `prisma include` для сохранения связанных сущностей (tservices, tlocations, tcontacts, tcategories_options)

### 3.4 Создать кнопку отправки ✅
- **Компонент**: `CreateServiceButton`
- **Интеграция**: В `ServiceRegistrationForm`
- **Состояния**: Загрузка, успех, ошибка

### 3.5 Создать утилиту ServiceOptions с константами ✅
- **Файл**: `src/utils/serviceOptions.ts`
- **Подход**: Константы для MVP вместо БД
- **Данные**: PROPERTY, TRANSFER, MEAL с их опциями
- **Назначение**: Временное решение для MVP, потом перенести в БД

### 3.6 Добавить поле serviceOptions в таблицу tservices ✅
- **Таблица**: `tservices` (расширить существующую)
- **Поле**: `serviceOptions` типа JSON для хранения массива опций
- **Назначение**: Сохранение выбранных опций для сервиса

## Статус выполнения задач

**Легенда:**
- ⏳ - В ожидании выполнения
- ✅ - Выполнено
- 🔄 - В процессе выполнения

**Детали реализации:**

### 3.1 Создать endpoint ✅
- **Создано**: API Route `src/app/api/services/create/route.ts`
- **Реализован**: POST метод с валидацией и обработкой ошибок
- **Особенности**: 
  - Валидация обязательных полей и типов данных
  - Детальная обработка ошибок с HTTP статусами
  - Стандартизированный JSON ответ

**Пример запроса:**
```json
POST /api/services/create
{
  "name": "Уборка квартиры",
  "description": "Профессиональная уборка квартир и домов",
  "price": "2500",
  "tcategories_id": 15,
  "address": "ул. Ленина, 10, Москва",
  "tarea_id": 3,
  "phone": "+7 (999) 123-45-67",
  "tg_username": "@clean_service",
  "serviceOptions": ["wi-fi", "бассейн", "парковка"]
}
```

**Пример ответа (201):**
```json
{
  "success": true,
  "message": "Service created successfully",
  "service": {
    "id": 42,
    "name": "Уборка квартиры",
    "description": "Профессиональная уборка квартир и домов",
    "price": "2500",
    "tcategories_id": 15,
    "provider_id": 7,
    "status": "active",
    "created_at": "2024-01-15T10:30:00.000Z",
    "tcontacts": [
      {
        "id": 101,
        "tservices_id": 42,
        "email": "default@example.com",
        "phone": "+7 (999) 123-45-67",
        "tg_username": "@clean_service",
        "website": null,
        "whatsap": null
      }
    ],
    "tlocations": [
      {
        "id": 201,
        "tservices_id": 42,
        "name": null,
        "address": "ул. Ленина, 10, Москва",
        "latitude": null,
        "longitude": null,
        "tarea_id": 3,
        "description": null
      }
    ]
  }
}
```

### 3.2 Реализовать сервисный слой ✅
- **Создано**: `ServiceRegistrationService` в `src/service/ServiceRegistrationService.ts`
- **Реализован**: метод `createService()` с валидацией данных
- **Особенности**: 
  - Минимальная валидация для MVP (обязательные поля, цена > 0)
  - Обработка ошибок с логированием
  - Следует архитектурному паттерну существующих сервисов

### 3.3 Реализовать репозиторный слой ✅
- **Создано**: `CreateServiceEntity` в `src/entity/CreateServiceEntity.ts`
- **Создано**: `ServiceCreateModel` в `src/model/ServiceCreateModel.ts`
- **Добавлено**: метод `createService()` в `ServiceRepository` с использованием `prisma include`
- **Особенности**: 
  - Создание сервиса, контактов и локации одним запросом
  - Хардкод `provider_id: 7` согласно спецификации MVP
  - Обязательное поле `email` в контактах заполняется значением по умолчанию

### 3.5 Создать утилиту ServiceOptions с константами ✅
- **Создано**: утилита `src/utils/serviceOptions.ts`
- **Подход**: Константы для MVP вместо БД таблицы
- **Структура данных**: 
  - `PROPERTY` - Недвижимость: ["wi-fi", "бассейн", "кондиционер", "кухня", "парковка", "спортзал", "сауна", "детская площадка"]
  - `TRANSFER` - Трансфер: ["встреча в аэропорту", "доставка до отеля", "групповой трансфер", "VIP трансфер", "детское кресло", "багаж включен"]
  - `MEAL` - Питание: ["завтрак", "полупансион", "полный пансион", "аллергическое меню", "вегетарианское", "диетическое", "детское меню"]
- **Функциональность**: 
  - `getServiceCategories()` - получить все категории
  - `getOptionsForCategory(category)` - получить опции для категории
  - `getCategoryDescription(category)` - получить описание категории
  - `isValidCategory(category)` - проверить существование категории
  - `getAllOptions()` - получить все опции (плоский список)
- **Преимущества MVP**: 
  - Быстрое прототипирование без БД
  - Простота изменения опций
  - Легко перенести в БД в будущем
- **Назначение**: Временное решение для MVP, потом заменить на полноценную БД таблицу

### 1.1 Создать баннер на странице "Каталог" ✅
- **Создано**: компонент `ServiceRegistrationBanner` в `src/components/ServiceRegistrationBanner.tsx`
- **Реализован**: баннер с градиентным фоном и кнопкой "Подключить бизнес"
- **Особенности**: 
  - Клиентский компонент с использованием `useRouter` для навигации
  - Адаптивный дизайн с Tailwind CSS
  - Hover эффекты и анимации для кнопки
  - Размещение в начале страницы каталога перед списком категорий
- **Интеграция**: добавлен в `src/app/catalog/Catalog.tsx` как первый элемент

### 1.2 Создать страницу регистрации сервиса ✅
- **Создано**: страница `src/app/services/registration/page.tsx`
- **Реализован**: компонент `ServiceRegistrationPage` с базовой структурой
- **Особенности**: 
  - Серверный компонент с использованием существующих компонентов Header и SearchBar
  - Адаптивный дизайн с Tailwind CSS (max-w-4xl, центрирование)
  - Заголовок и описание страницы
  - Интегрирована форма регистрации сервиса
- **Маршрут**: `/services/registration` доступен для навигации

### 2.1 Создать основную форму ✅
- **Создано**: компонент `ServiceRegistrationForm` в `src/app/services/registration/_components/ServiceRegistrationForm.tsx`
- **Реализован**: полная форма регистрации с React Hook Form + Zod
- **Особенности**: 
  - Разделена на логические секции (Основная информация, Категория, Локация, Контакты)
  - Интеграция с хуком `useServiceRegistration`
  - Отображение ProgressBar и ResultModal
  - Адаптивная сетка для полей
- **Архитектура**: Модульная структура с отдельными компонентами для каждого поля

### 2.2 Реализовать поля сервиса ✅
- **Создано**: все компоненты полей сервиса
- **Компоненты**: 
  - `ServiceNameInput` - поле названия с валидацией
  - `ServiceDescriptionInput` - поле описания (textarea)
  - `ServicePriceInput` - поле цены с символом рубля
  - `ServiceAddressInput` - поле адреса
  - `ServicePhoneInput` - поле телефона
  - `ServiceTelegramInput` - поле Telegram с символом @
- **Особенности**: 
  - Единообразный дизайн с Tailwind CSS
  - Отображение ошибок валидации
  - TypeScript типизация через React Hook Form
  - Placeholder'ы и labels для всех полей

### 3.4 Создать кнопку отправки ✅
- **Создано**: компонент `CreateServiceButton` в `src/app/services/registration/_components/CreateServiceButton.tsx`
- **Реализован**: кнопка с состояниями загрузки и валидации
- **Особенности**: 
  - Отображение спиннера во время отправки
  - Блокировка при невалидной форме
  - Hover эффекты и анимации
  - Адаптивный текст ("Создать сервис" / "Создание сервиса...")
- **UX**: Визуальная обратная связь для пользователя

### 2.3 Реализовать выбор категории ✅
- **Создано**: компонент `CategorySelectionModal` в `src/app/services/registration/_components/CategorySelectionModal.tsx`
- **Реализован**: полноценный выбор категорий с иерархической структурой
- **Особенности**: 
  - Модальное окно с загрузкой категорий
  - Отображение родительских и дочерних категорий
  - Визуальное разделение уровней (родитель → дочерняя)
  - Адаптивная сетка для дочерних категорий
  - Загрузка данных через API endpoint
- **Архитектура**: 
  - `ParentCategoryWithChildren` интерфейс в `src/model/CategoryType.ts`
  - `findAllParentWithChildren()` метод в `CategoryRepository` с `prisma include`
  - `getAllParentWithChildren()` метод в `CategoryService`
  - API endpoint `/api/categories/parent-with-children`
- **UX**: Интуитивный выбор с визуальной иерархией и hover эффектами

### 2.4 Реализовать поля локации ✅
- **Создано**: компонент `ServiceAreaSelect` в `src/app/services/registration/_components/ServiceAreaSelect.tsx`
- **Реализован**: полноценный выбор зон с поиском и иерархией
- **Особенности**: 
  - Модальное окно с загрузкой зон
  - Поиск по названию и системному имени
  - Разделение на основные зоны и подзоны
  - Адаптивная сетка для отображения зон
  - Загрузка данных через API endpoint
- **Архитектура**: 
  - `AreaEntity` интерфейс в `src/entity/AreaEntity.ts`
  - `AreaRepository` с методами `findAll()`, `findAllParent()`, `findByParentId()`
  - `AreaService` для бизнес-логики
  - API endpoint `/api/areas`
- **UX**: Удобный поиск и выбор с визуальным разделением уровней зон

### 2.5 Реализовать поля контактов ✅
- **Создано**: компоненты `ServicePhoneInput` и `ServiceTelegramInput` в `src/app/services/registration/_components/`
- **Реализован**: полноценные поля для ввода контактной информации
- **Особенности**: 
  - `ServicePhoneInput` - поле телефона с типом `tel` и валидацией
  - `ServiceTelegramInput` - поле Telegram с символом @ и валидацией
  - Интеграция с React Hook Form для управления состоянием
  - Отображение ошибок валидации с соответствующими стилями
  - Placeholder'ы для удобства пользователя
- **Архитектура**: 
  - Компоненты интегрированы в `ServiceRegistrationForm`
  - Используют `useFormRegister` для связи с формой
  - Валидация через Zod схему `createServiceSchema`
- **UX**: Единообразный дизайн с другими полями формы, понятные placeholder'ы

### 2.6 Реализовать выбор опций категорий ✅
- **Создано**: компонент `ServiceOptionsSelection` в `src/app/services/registration/_components/ServiceOptionsSelection.tsx`
- **Реализован**: полноценный выбор опций с независимым отображением
- **Особенности**: 
  - Отображение всех доступных опций независимо от выбранной категории
  - Интерактивные чекбоксы с красивым UI
  - Кнопки "Выбрать все" и "Снять выбор" для удобства
  - Адаптивная сетка (1-3 колонки) для отображения опций
  - Счетчик выбранных опций с детальным отображением
- **Архитектура**: 
  - Интеграция с утилитой `ServiceOptions` для получения всех доступных опций
  - Использование `useEffect` для загрузки опций при монтировании компонента
  - Сохранение выбранных опций в поле `serviceOptions` таблицы `tservices` (JSON)
- **UX**: Интуитивный выбор опций с визуальной обратной связью, удобные кнопки управления

### Дополнительные UX компоненты ✅
- **ProgressBar**: Отображение процесса создания сервиса в верхней части экрана
- **ResultModal**: Модальные окна для отображения успеха/ошибки с возможностью перехода к созданному сервису
- **Валидация**: Zod схема с детальными сообщениями об ошибках для каждого поля
- **Состояния**: Обработка загрузки, успеха и ошибок с соответствующими UI элементами

### 3.6 Добавить поле serviceOptions в таблицу tservices ✅
- **Создано**: поле `serviceOptions` в модели `tservices` в `prisma/schema.prisma`
- **Тип**: `Json?` (nullable JSON для хранения массива опций)
- **Назначение**: Сохранение выбранных опций сервиса для каждого сервиса
- **Пример данных**: `["wi-fi", "бассейн", "парковка"]`
- **Особенности**: 
  - Поле nullable (может быть пустым для сервисов без опций)
  - JSON тип позволяет гибко хранить различные массивы опций
  - Интеграция с утилитой `ServiceOptions` для валидации
- **Обновлено**: 
  - `ServiceCreateModel.serviceOptions` - тип изменен с `number[]` на `string[]`
  - `CreateServiceEntity.serviceOptions` - добавлено поле для возврата данных
  - `ServiceRepository.createService()` - сохранение и возврат `serviceOptions`

## Диаграмма взаимодействия компонентов

```
Страница "Каталог"
       │
       ▼
┌─────────────────────────────────┐
│     ServiceRegistrationBanner   │
│         "Подключить бизнес"     │
└─────────────────────────────────┘
       │ (клик)
       ▼
┌─────────────────────────────────┐
│   /services/registration        │
│   ServiceRegistrationPage       │
└─────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│   ServiceRegistrationForm       │
│   ├─ ServiceNameInput          │
│   ├─ ServiceDescriptionInput   │
│   ├─ ServicePriceInput         │
│   ├─ CategorySelectionModal    │
│   ├─ ServiceAddressInput       │
│   ├─ ServiceAreaSelect         │
│   ├─ ServicePhoneInput         │
│   ├─ ServiceTelegramInput      │
│   ├─ ServiceOptionsSelection   │
│   └─ CreateServiceButton       │
└─────────────────────────────────┘
       │ (отправка формы)
       ▼
┌─────────────────────────────────┐
│   useServiceRegistration Hook   │
└─────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│   /api/services/create          │
│   ServiceRegistrationService    │
└─────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│   Repository Layer              │
│   ├─ CategoryRepository        │
│   ├─ AreaRepository            │
│   └─ ServiceRepository         │
└─────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│   Database                     │
│   ├─ tservices                 │
│   ├─ tcategories               │
│   ├─ tlocations                │
│   ├─ tcontacts                 │
│   ├─ tarea                     │
│   └─ tservices (с полем serviceOptions) │
└─────────────────────────────────┘
```

## Структура БД

### Поле `serviceOptions` в таблице `tservices`
```sql
-- Поле добавлено в существующую таблицу tservices
serviceOptions JSON -- Массив строк с выбранными опциями сервиса
```

## Файловая структура
```
src/
├── app/
│   ├── services/
│   │   └── registration/
│   │       ├── _components/
│   │       │   ├── ServiceRegistrationForm.tsx
│   │       │   ├── CategorySelectionModal.tsx
│   │       │   ├── CategoryOptionsSelection.tsx
│   │       │   ├── ServiceNameInput.tsx
│   │       │   ├── ServiceDescriptionInput.tsx
│   │       │   ├── ServicePriceInput.tsx
│   │       │   ├── ServiceAddressInput.tsx
│   │       │   ├── ServiceAreaSelect.tsx
│   │       │   ├── ServicePhoneInput.tsx
│   │       │   ├── ServiceTelegramInput.tsx
│   │       │   └── CreateServiceButton.tsx
│   │       ├── _hooks/
│   │       │   └── useServiceRegistration.ts
│   │       └── page.tsx
│   └── api/
│       └── services/
│           └── create/
│               └── route.ts
├── components/
│   └── ServiceRegistrationBanner.tsx
├── service/
│   └── ServiceRegistrationService.ts
├── repository/
│   └── ServiceRepository.ts
├── utils/
│   └── serviceOptions.ts
└── types/
    ├── service.ts
    ├── category.ts
    └── area.ts
```
