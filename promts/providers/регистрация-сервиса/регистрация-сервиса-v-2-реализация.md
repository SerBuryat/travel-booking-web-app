# План реализации регистрации сервиса v.2

## Обзор задачи
При регистрации сервиса, если у клиента нет "бизнес-аккаунта", он должен ввести данные контактного лица. После регистрации создается бизнес-аккаунт, роль клиента переключается на 'provider', происходит редирект на `/provider/services`.

## Декомпозиция на задачи

### 1. Создание API для переключения клиента на провайдера
**Статус:** ⏳ Ожидает выполнения

#### 1.1 Создание ProviderRepository ✅ ВЫПОЛНЕНО
- [x] Создать `src/repository/ProviderRepository.ts`
- [x] Реализовать метод `findByClientId(clientId: number): Promise<ProviderEntity | null>`
- [x] Добавить типы для провайдера в `src/entity/ProviderEntity.ts`

#### 1.2 Создание ProviderService ✅ ВЫПОЛНЕНО
- [x] Создать `src/service/ProviderService.ts`
- [x] Реализовать метод `getProvider(clientId: number): Promise<any>`

#### 1.3 Создание AuthService методов ✅ ВЫПОЛНЕНО
- [x] В `src/service/AuthService.ts` добавить метод `authProvider(userId: number, authId: number)`
- [x] Реализовать логику переключения роли с 'user' на 'provider'

#### 1.4 Создание API endpoint ✅ ВЫПОЛНЕНО
- [x] Создать `src/app/api/auth/provider/route.ts`
- [x] Реализовать POST метод для переключения на провайдера
- [x] Добавить валидацию JWT

### 2. Создание страницы `/provider/services`
**Статус:** ✅ ВЫПОЛНЕНО

#### 2.1 Создание страницы ✅ ВЫПОЛНЕНО
- [x] Создать `src/app/provider/services/page.tsx`
- [x] Добавить проверку роли (только для 'provider')
- [x] Добавить редирект на `/home` для неавторизованных пользователей

#### 2.2 Создание компонента ProviderServicesComponent ✅ ВЫПОЛНЕНО
- [x] Создать `src/app/provider/services/_components/ProviderServicesComponent.tsx`
- [x] Реализовать отображение списка сервисов провайдера
- [x] Добавить загрузку данных через server action

#### 2.3 Создание server action ✅ ВЫПОЛНЕНО
- [x] В `ProviderService.ts` добавить метод `getAllServices(providerId: number)`
- [x] В `ServiceRepository.ts` добавить метод `getAllByProviderId(providerId: number)`
- [x] Реализовать загрузку сервисов по `provider_id`

### 3. Обновление баннера регистрации сервиса
**Статус:** ✅ ВЫПОЛНЕНО

#### 3.1 Создание API для проверки существования бизнес-аккаунта ✅ ВЫПОЛНЕНО
- [x] Создать `src/app/api/provider/profile/route.ts`
- [x] Реализовать GET метод для получения информации о провайдере
- [x] Использовать `ProviderService.getProviderForClient(clientId)`

#### 3.2 Обновление ServiceRegistrationBanner ✅ ВЫПОЛНЕНО
- [x] В `src/components/ServiceRegistrationBanner.tsx` добавить проверку существования бизнес-аккаунта
- [x] Показать модальное окно с информацией о существующем аккаунте
- [x] Предложить переход на `/provider/services` или `/services/registration`
- [x] Баннер всегда виден, проверка происходит при нажатии кнопки
- [x] Loading состояние во время проверки
- [x] Переход через `/api/auth/provider` для смены роли на провайдера

### 4. Обновление формы регистрации сервиса
**Статус:** ✅ ВЫПОЛНЕНО

#### 4.1 Добавление секции "Данные контактного лица" ✅ ВЫПОЛНЕНО
- [x] Создать `src/app/services/registration/_components/ProviderCompanyNameInput.tsx`
- [x] Создать `src/app/services/registration/_components/ProviderContactPersonInput.tsx`
- [x] Создать `src/app/services/registration/_components/ProviderPhoneInput.tsx`
- [x] Добавить компоненты в `ServiceRegistrationForm.tsx`

#### 4.2 Обновление моделей данных ✅ ВЫПОЛНЕНО
- [x] Расширить `src/model/ServiceCreateModel.ts` с полями провайдера
- [x] Обновить `src/schemas/serviceRegistrationSchema.ts` для валидации полей провайдера
- [x] Добавить валидацию обязательных полей провайдера

#### 4.3 Обновление логики создания сервиса ✅ ВЫПОЛНЕНО
- [x] В `ProviderRepository.ts` добавить метод `createProvider`
- [x] В `ProviderService.ts` добавить метод `createOrGetProvider`
- [x] Обновить `ServiceRegistrationService.ts` для работы с провайдерами
- [x] Обновить `ServiceRepository.ts` для работы с `providerId`
- [x] Обновить API endpoint `/api/services/create` для валидации полей провайдера
- [x] Обновить `useServiceRegistration` хук для работы с новыми полями
- [x] Обновить `ResultModal` для показа кнопки перехода в бизнес-аккаунт
- [x] После успешного создания предложить переход в бизнес-аккаунт через `/api/auth/provider`

### 5. Отображение navbar на основе роли
**Статус:** ✅ ВЫПОЛНЕНО

#### 5.1 Обновление Header компонента ✅ ВЫПОЛНЕНО
- [x] В `src/utils/navbar.tsx` добавлена логика отображения кнопок на основе роли
- [x] Показывать "Каталог" для 'user' и "Мои объекты" для 'provider'
- [x] Реализовано переключение между ролями в navbar

#### 5.2 Создание страницы "Мои объекты" ✅ ВЫПОЛНЕНО
- [x] Создана `src/app/provider/services/page.tsx` (альтернатива `/provider/services`)
- [x] Реализовано отображение сервисов текущего провайдера
- [x] Добавлен редирект для пользователей без роли 'provider'

### 6. Тестирование и интеграция
**Статус:** ⏳ Ожидает выполнения

#### 6.1 Создание тестов
- [ ] Тесты для `ProviderService.ts`
- [ ] Тесты для `ProviderRepository.ts`
- [ ] Тесты для API endpoints
- [ ] Тесты для компонентов

#### 6.2 Интеграционные тесты
- [ ] Тест полного flow регистрации сервиса
- [ ] Тест переключения на провайдера
- [ ] Тест отображения страницы `/provider/services`

## Неясности и вопросы для обсуждения

### 1. Структура данных провайдера
- Нужно ли создавать отдельную таблицу для контактных данных провайдера?
- Как связать `tproviders` с `tservices` через `provider_id`?

### 2. Переключение между аккаунтами
- Как реализовать переключение между обычным пользователем и провайдером?
- Нужно ли сохранять обе роли или переключать существующую?

### 3. Валидация данных
- Какие поля обязательны для создания провайдера?
- Нужна ли проверка уникальности телефона/email провайдера?

### 4. Безопасность
- Как защитить API endpoints от несанкционированного доступа?
- Нужна ли дополнительная аутентификация для провайдеров?

## Порядок выполнения

1. **Начать с создания базовых репозиториев и сервисов** (задача 1.1-1.3)
2. **Реализовать API для переключения роли** (задача 1.4)
3. **Создать страницу провайдера** (задача 2)
4. **Обновить баннер регистрации** (задача 3)
5. **Расширить форму регистрации** (задача 4)
6. **Обновить navbar на основе роли** (задача 5)
7. **Добавить тесты** (задача 6)

## Критерии готовности

- [ ] Все API endpoints работают корректно
- [ ] Форма регистрации сервиса создает провайдера
- [ ] Переключение роли работает без ошибок
- [ ] Страница `/provider/services` отображает сервисы
- [ ] Navbar корректно отображает кнопки по ролям
- [ ] Все тесты проходят успешно
- [ ] Документация обновлена

## Примечания

- Каждая задача должна быть реализована отдельно для упрощения ревью
- При возникновении проблем с одной задачей, можно переходить к следующей
- Регулярно обновлять статус выполнения задач
- Тестировать каждую задачу после завершения
