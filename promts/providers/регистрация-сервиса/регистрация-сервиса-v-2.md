# Регистрация сервиса v.2

## Задача
При регистрации сервиса, если у клиента нет "бизнес-аккаунта" (нет записи `tproviders.tclients_id = 
<current-user-id>`), он должен ввести данные в секцию "Данные контактного лица" - заполнить имя и телефон.
При нажатии на кнопку "Создать сервис", помимо регистрации сервиса, будет также создана запись для "бизнес-аккаунта" (в `tproviders`
c `tproviders.tclients_id = <current-user-id>`).
После регистрации аккаунта и сервиса, аккаунт (`tclients_auth.role`) клиента и его jwt будут переключены на `role = 
'provider'` и произойдет редирект на страницу`/provider/services`, где он сможет увидеть его созданный объект.
При переключении на "бизнес-аккаунт" в navbar происходит смена кнопки "Каталог" на "Мои объекты" (у клиентов 
"Каталог" у "бизнес-аккаунтов" "Мои объекты")

## Ниды:
- При нажатии "Подключить бизнес" на странице "Каталог", если у пользователя уже есть "бизнес-аккаунт" показать ему 
  данные этого аккаунта в модальном окне и предложить перейти в этот аккаунт (редирект на `/provider/services`)
- Если у пользователя нет "бизнес-аккаунта" он просто переходит на форму регистрации сервиса 
  (`/services/registgration`), как раньше
- На форме регистрации сервиса нужно добавить секцию "Данные контактного лица" с двумя полями "Контактное лицо" и 
  "Номер телефона"
- при нажатии кнопки "Создать сервис", добавить процесс создания "бизнес-аккаунта" и привязать к ней `id` текущего 
  пользователя
- после успешного создания "бизнес-аккаунта" и регистрации сервиса показать модальное окно об успехе и предложить 
  перейти в бизнес-аккаунт
- при переходе в "бизнес-аккаунт" переключить ролько клиента с `user` на `provider`
- пользователь переходит на страницу `/provider/services`
- создать страницу `/provider/services` и отобразить на ней сервисы которые принадлежат "бизнес-аккаунту" клиента 
  по `id` "бизнес-аккаунта"
- при переключении клиента на "бизнес-аккаунт", также переключить в navbar кнопку "Каталог" на "Мои объекты" 
  (отображение кнопок navbar на основании роли)

## Технические компоненты и реализация

### Переключение клиента на "бизнес-аккаунт"
- создать API `/auth/provider`
  - переключить клиента на провайдера через `AuthService.authProvider(jwt.userId, jwt.authId)`
  - создать `AuthService.authProvider(jwt.userId, jwt.authId)`
    - проверить, что у клиента существует "бизнес-аккаунт"
      - создать `ProviderService.exists(clientId)` -> `ProviderRepository.existsByClientId(clientId)`
      - если не существует, выдать ошибку, что у клиента нет "бизнес-аккаунта"
    - получить активную учетную запись
      - создать `AuthService.findActive(authId)` -> `AuthRepository.findActiveById(authId)`
    - обновить роль активной учетки 
      - `activeAuth.role('provider')`
    - обновить учетку с новой ролью
    - создать и сохранить с новой ролью `AuthRepository.update(activeAuth)`
    - пересоздать jwt с новым `activeAuth`
      - `generateJWT`

### Страница `/provider/services`
- создать страницу `/provider/services`
- разрешить заходить на нее только с ролью `provider` (`getServerUser.role === 'provider'`) иначе редирект в `/home`
- создать компонент `ProviderServicesComponent`
  - через `props` передать `tservices`
  - `tservices` загрузить через server action `ProviderService.getAllServices(providerId)`
  - создать `ProviderService.getAllServices(providerId)`, который будет `ServiceRepository.getAllByProviderId
  (providerId)`
  - создать `ServiceRepository.getAllByProviderId(providerId)` котрые будет загружать `tservices where provider_id = 
  <client-provider-id>`
  - `providerId` взять из `ProviderService.getProvider(clientId)`
  - создать `ProviderService.getProvider(clientId)` и достать данные из `ProviderRepository.findByClientId(clientId)`
  - создать `ProviderRepository.findByClientId(clientId)` и получать данный провайдера из `tproviders where 
  tclients_id = clientId`

### Баннер регистрации сервиса  

- при нажатии на "Подключить бизнес" на `ServiceRegistrationBanner` проверить, есть ли у клиента существующий 
  "бизнес-аккаунт"
  - создать api `/provider/profile`
  - использовать `ProviderService.getProvider(clientId)`
  - если у клиента, есть существующий "бизнес-аккаунт", выдать информацию по нему и предложить перейти на `/provider/services`
  - если у клиента нет "бизнес-аккаунта", он переходит на `/services/registration`

### Создание "бизнесс-аккаунт" при регистрации сервиса

- в `ServiceRegistrationForm` добавить новую секцию "Данные контактного лица" `ProviderNameInput` и `ProviderPhoneInput`
- расширить `ServiceCreateModel` с provider
- `CreateServiceEntity` добавить `tproviders` для `include`
- сохранять провайдера в `serviceRepository.createService(serviceData)`
- после успешного создания провайдера и сервиса, предлагать, вместо посмотреть созданный сервис, перейти в 
  "бизнес-аккаунт" `/provider/services`

### Отображение navbar на основе роли

- В зависимости от роли пользователя 
  - для `user` показывать "Каталог" `/catalog`
  - для `provider` показывать, вместо "Каталог", "Мои объекты" `/providers/services`