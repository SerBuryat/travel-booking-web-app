# User Story: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Mini Apps

## üìã –û–ø–∏—Å–∞–Ω–∏–µ
**–ö–∞–∫** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram  
**–Ø —Ö–æ—á—É** –≤–æ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Mini Apps  
**–ß—Ç–æ–±—ã** –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏
- [x] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –∏–∑ Telegram Mini Apps –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- [x] –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è
- [x] –°–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ
- [x] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∞–º
- [x] –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ –±–æ–ª–µ–µ 30 —Å–µ–∫—É–Ω–¥

## üîÑ –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å

### –®–∞–≥ 1: –ü–µ—Ä–µ—Ö–æ–¥ –∏–∑ Telegram Mini Apps
**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤ Telegram Mini Apps  
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** 
- `src/app/telegram-auth/page.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `getInitData()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ URL hash

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ Telegram
2. –°–∏—Å—Ç–µ–º–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç `tgWebAppData` –∏–∑ `window.location.hash`
3. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

### –®–∞–≥ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö Telegram
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `src/app/api/auth/telegram/route.ts` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- `@telegram-apps/init-data-node` - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `initData` –Ω–∞ `/api/auth/telegram`
2. –°–∏—Å—Ç–µ–º–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å —Å –ø–æ–º–æ—â—å—é `BOT_TOKEN`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç `TelegramUser` –∏–ª–∏ –æ—à–∏–±–∫–∞

### –®–∞–≥ 3: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"  
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `src/app/api/auth/login-telegram/route.ts` - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `src/service/ClientService.ts` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- `src/repository/ClientRepository.ts` - —Ä–∞–±–æ—Ç–∞ —Å –ë–î
- `src/lib/jwt.ts` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è `authId = "telegram_${user.id}"`
2. –°–æ–∑–¥–∞–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω (1 —á–∞—Å) –∏ refresh —Ç–æ–∫–µ–Ω (7 –¥–Ω–µ–π)
3. –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   - –°–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `tclients`
   - –°–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `tclients_auth`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è refresh token
4. –¢–æ–∫–µ–Ω—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ httpOnly cookies
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/home`

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```typescript
// –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
src/app/telegram-auth/page.tsx
‚îú‚îÄ‚îÄ getInitData() - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ URL
‚îú‚îÄ‚îÄ validateInitData() - –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ API
‚îî‚îÄ‚îÄ handleLogin() - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
```

### Backend API
```typescript
// –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram –¥–∞–Ω–Ω—ã—Ö
POST /api/auth/telegram
‚îú‚îÄ‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è initData
‚îú‚îÄ‚îÄ –ü–∞—Ä—Å–∏–Ω–≥ user –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ –í–æ–∑–≤—Ä–∞—Ç TelegramUser

// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
POST /api/auth/login-telegram
‚îú‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh token
‚îî‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cookies
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
tclients
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ name
‚îú‚îÄ‚îÄ email
‚îú‚îÄ‚îÄ additional_info (JSON —Å Telegram –¥–∞–Ω–Ω—ã–º–∏)
‚îî‚îÄ‚îÄ created_at

-- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
tclients_auth
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ tclients_id (FK)
‚îú‚îÄ‚îÄ auth_type = 'telegram'
‚îú‚îÄ‚îÄ auth_id = 'telegram_${user.id}'
‚îú‚îÄ‚îÄ refresh_token
‚îú‚îÄ‚îÄ token_expires_at
‚îú‚îÄ‚îÄ role = 'user'
‚îî‚îÄ‚îÄ is_active = true
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å
```typescript
// –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await prisma.$transaction(async (tx) => {
  // –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const client = await findByAuthIdTx(tx, authId);
  
  if (client) {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
    await updateTx(tx, client.id, updateData);
    await updateAuthTx(tx, auth.id, authData);
  } else {
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
    const newClient = await createTx(tx, createData);
    await createAuthTx(tx, authData);
  }
});
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **HttpOnly cookies** - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS
- **–í–∞–ª–∏–¥–∞—Ü–∏—è Telegram** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î** - –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```typescript
// –¢–∏–ø—ã –æ—à–∏–±–æ–∫
enum AuthError {
  INVALID_TELEGRAM_DATA = 'Invalid Telegram data',
  USER_CREATION_FAILED = 'Failed to create user',
  TOKEN_GENERATION_FAILED = 'Failed to generate tokens',
  DATABASE_ERROR = 'Database operation failed'
}
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- **–í—Ä–µ–º—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:** < 30 —Å–µ–∫—É–Ω–¥
- **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞:** > 95%
- **–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:** < 1%
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ API:** < 500ms

## üîÑ –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤** - `/api/auth/refresh`
- **–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã** - `/api/auth/logout`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - `/api/auth/me`
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤** - `/api/auth/validate`

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
- –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ Telegram
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Ä–æ–ª—å 'user'
- Refresh —Ç–æ–∫–µ–Ω—ã –∏–º–µ—é—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è 7 –¥–Ω–µ–π
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞

---
**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2024-12-19  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 